<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>拼圖遊戲 + 自動播放影片</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background-color: #f0f0f0;
    }
    /* 拼圖容器（尺寸會動態依據圖片及視窗計算） */
    #puzzle-container {
      position: relative;
      margin: 0 auto;
    }
    /* 每個拼圖塊 */
    .tile {
      position: absolute;
      border: 1px solid #ccc;
      box-sizing: border-box;
      cursor: pointer;
      /* 背景圖片將顯示拼圖區塊對應的部分 */
    }
    /* 隱藏影片（初始狀態） */
    video {
      width: 100%;
      max-width: 800px;
      display: none;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <!-- 拼圖容器 -->
  <div id="puzzle-container"></div>

  <!-- 遊戲結束後自動播放影片 (加入 muted 與 playsinline 可提高自動播放成功率) -->
  <video id="video-player" controls muted playsinline>
    <source src="movie/your_video.mp4" type="video/mp4">
    您的瀏覽器不支援影片播放。
  </video>

  <script>
    // 設定參數：請將 imageSrc 換成你用於拼圖的圖片檔案路徑
    const imageSrc = 'images/your_image.jpg';
    const puzzleContainer = document.getElementById('puzzle-container');
    const videoPlayer = document.getElementById('video-player');

    // 拼圖設定（例如：3 x 3 拼圖）
    const cols = 3;
    const rows = 3;
    let imageWidth, imageHeight, tileWidth, tileHeight;
    let tiles = [];
    let originalOrder = [];
    let selectedTile = null;

    // 初始化遊戲：讀取圖片、計算尺寸、建立、打亂及渲染拼圖
    function initGame() {
      const img = new Image();
      img.src = imageSrc;
      img.onload = function(){
        // 取得圖片原始尺寸
        const oriWidth = img.naturalWidth;
        const oriHeight = img.naturalHeight;
        
        // 計算縮放比例：使拼圖尺寸不超過視窗的 90%
        const maxWidth = window.innerWidth * 0.9;
        const maxHeight = window.innerHeight * 0.9;
        const scale = Math.min(maxWidth / oriWidth, maxHeight / oriHeight, 1);
        
        imageWidth = oriWidth * scale;
        imageHeight = oriHeight * scale;
        tileWidth = imageWidth / cols;
        tileHeight = imageHeight / rows;
        
        // 設定拼圖容器尺寸
        puzzleContainer.style.width = imageWidth + "px";
        puzzleContainer.style.height = imageHeight + "px";
        
        // 建立拼圖資料
        generatePuzzle();
        shuffleTiles();
        renderPuzzle();
      }
    }

    // 建立包含正確排序的陣列 (原始順序)
    function generatePuzzle() {
      tiles = [];
      originalOrder = [];
      for (let i = 0; i < cols * rows; i++) {
        tiles.push(i);
        originalOrder.push(i);
      }
    }

    // 使用 Fisher-Yates 洗牌法隨機打亂拼圖順序
    function shuffleTiles() {
      for (let i = tiles.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [tiles[i], tiles[j]] = [tiles[j], tiles[i]];
      }
    }

    // 渲染拼圖，每個拼圖塊依據其對應背景位置顯示圖片局部內容
    function renderPuzzle() {
      puzzleContainer.innerHTML = "";
      tiles.forEach((tile, index) => {
        const tileElement = document.createElement('div');
        tileElement.classList.add('tile');
        tileElement.style.width = tileWidth + "px";
        tileElement.style.height = tileHeight + "px";

        // 計算每個拼圖塊在容器中的位置（根據索引）
        const posX = (index % cols) * tileWidth;
        const posY = Math.floor(index / cols) * tileHeight;
        tileElement.style.left = posX + "px";
        tileElement.style.top = posY + "px";

        // 設定背景，依據 tile 數值計算原圖中對應位置
        const bgX = -(tile % cols) * tileWidth;
        const bgY = -Math.floor(tile / cols) * tileHeight;
        tileElement.style.backgroundImage = `url(${imageSrc})`;
        tileElement.style.backgroundSize = `${imageWidth}px ${imageHeight}px`;
        tileElement.style.backgroundPosition = `${bgX}px ${bgY}px`;
        
        tileElement.addEventListener('click', () => {
          handleTileClick(index);
        });
        puzzleContainer.appendChild(tileElement);
      });
    }

    // 選取拼圖塊並交換位置
    function handleTileClick(index) {
      if (selectedTile === null) {
        selectedTile = index;
      } else {
        [tiles[selectedTile], tiles[index]] = [tiles[index], tiles[selectedTile]];
        selectedTile = null;
        renderPuzzle();
        checkCompletion();
      }
    }

    // 檢查是否完成拼圖：若每個位置的數值均對應原始順序則完成拼圖
    function checkCompletion() {
      if (tiles.every((tile, index) => tile === originalOrder[index])) {
        // 拼圖完成：隱藏拼圖容器...
        puzzleContainer.style.display = "none";
        // ...顯示影片並自動播放
        videoPlayer.style.display = "block";
        videoPlayer.play().catch(error => {
          console.error("影片播放失敗:", error);
        });
      }
    }

    // 自動初始化遊戲
    window.onload = initGame;

    // 可選：監聽視窗 resize 事件，自動調整拼圖（注意：會重置遊戲）
    window.onresize = function() {
      initGame();
    };
  </script>
</body>
</html>
