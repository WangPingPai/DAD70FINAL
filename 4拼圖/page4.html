<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>全螢幕播放影片的拼圖遊戲</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background-color: #f0f0f0;
      overflow: hidden;
    }

    #puzzle-container {
      display: flex;
      flex-wrap: wrap;
      position: relative;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: transform 0.3s ease;
    }

    .tile {
      background-repeat: no-repeat;
      background-size: cover;
      background-position: center;
      cursor: pointer;
      box-sizing: border-box;
      transition: transform 0.2s ease;
    }

    .tile:hover {
      transform: scale(1.05);
    }

    /* 影片區：新增 muted 與 playsinline 以利自動播放 */
    video {
      width: 100%;
      height: 100%;
      display: none;
    }

    #message {
      text-align: center;
      margin-top: 20px;
      font-size: 1.2em;
      font-weight: bold;
    }

    /* 橫屏模式縮小70%並置中 */
    @media (orientation: landscape) {
      #puzzle-container {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%) scale(0.7);
      }
    }
  </style>
</head>
<body>
  <!-- 背景音樂（檔案路徑保持不變） -->
  <audio id="bg-music" src="您的音樂檔案路徑.mp3" loop></audio>
  <!-- 拼圖區域 -->
  <div id="puzzle-container"></div>
  <!-- 影片區域：保持影片檔案路徑 my_video.mp4，但新增 muted 與 playsinline 屬性 -->
  <video id="video-player" controls muted playsinline>
    <source src="my_video.mp4" type="video/mp4">
    您的瀏覽器不支援影片播放。
  </video>
  <p id="message"></p>

  <script>
    // 使用原本的圖片檔案路徑（front.jpg）
    const imageSrc = 'front.jpg';
    const puzzleContainer = document.getElementById('puzzle-container');
    const bgMusic = document.getElementById('bg-music');
    const message = document.getElementById('message');
    const videoPlayer = document.getElementById('video-player');

    // 設定拼圖參數：圖片尺寸、列數、行數
    const imageWidth = 900;  // 圖片寬度（請依實際圖片尺寸調整）
    const imageHeight = 600; // 圖片高度（請依實際圖片尺寸調整）
    const cols = 3;
    const rows = 3;
    const tileWidth = imageWidth / cols;
    const tileHeight = imageHeight / rows;

    let tiles = [];
    let originalOrder = [];
    let selectedTile = null;

    window.onload = function() {
      startGame();
    };

    function startGame() {
      // 設定拼圖容器尺寸與置中
      puzzleContainer.style.width = `${imageWidth}px`;
      puzzleContainer.style.height = `${imageHeight}px`;
      puzzleContainer.style.margin = '0 auto';
      // 播放背景音樂
      bgMusic.play().catch(e => console.error("背景音樂播放失敗:", e));
      generatePuzzle();
      shuffleTiles();
      renderPuzzle();
    }

    function generatePuzzle() {
      tiles = [];
      originalOrder = [];
      for (let i = 0; i < cols * rows; i++) {
        tiles.push(i);
        originalOrder.push(i);
      }
    }

    function shuffleTiles() {
      // 使用 Fisher-Yates 洗牌法
      for (let i = tiles.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [tiles[i], tiles[j]] = [tiles[j], tiles[i]];
      }
    }

    function renderPuzzle() {
      puzzleContainer.innerHTML = '';
      tiles.forEach((tile, index) => {
        const tileElement = document.createElement('div');
        tileElement.classList.add('tile');
        tileElement.style.width = `${tileWidth}px`;
        tileElement.style.height = `${tileHeight}px`;
        if (tile !== null) {
          // 計算每塊在背景圖中的位置
          const x = -(tile % cols) * tileWidth;
          const y = -Math.floor(tile / cols) * tileHeight;
          tileElement.style.backgroundImage = `url(${imageSrc})`;
          tileElement.style.backgroundSize = `${imageWidth}px ${imageHeight}px`;
          tileElement.style.backgroundPosition = `${x}px ${y}px`;
        }
        tileElement.addEventListener('click', () => handleTileClick(index));
        puzzleContainer.appendChild(tileElement);
      });
    }

    function handleTileClick(index) {
      if (selectedTile === null) {
        selectedTile = index;
      } else {
        [tiles[selectedTile], tiles[index]] = [tiles[index], tiles[selectedTile]];
        renderPuzzle();
        selectedTile = null;
        checkCompletion();
      }
    }

    // 當拼圖完成後執行，自動隱藏拼圖並播放影片
    function checkCompletion() {
      if (tiles.every((tile, index) => tile === originalOrder[index])) {
        message.textContent = '恭喜你完成拼圖！即將播放影片。';
        bgMusic.pause();
        // 略微延遲後嘗試自動撥放影片
        setTimeout(() => {
          playFullScreenVideo();
        }, 1000);
      }
    }

    function playFullScreenVideo() {
      // 隱藏拼圖容器
      puzzleContainer.style.display = "none";
      // 顯示影片
      videoPlayer.style.display = "block";
      // 嘗試以全螢幕模式播放（若支援的話）
      const requestFullScreen = videoPlayer.requestFullscreen ||
                                videoPlayer.webkitRequestFullscreen ||
                                videoPlayer.mozRequestFullScreen ||
                                videoPlayer.msRequestFullscreen;
      if (requestFullScreen) {
        requestFullScreen.call(videoPlayer);
      }
      // 自動撥放影片
      videoPlayer.play().catch(error => {
        console.error("影片播放失敗:", error);
      });
    }
  </script>
</body>
</html>
